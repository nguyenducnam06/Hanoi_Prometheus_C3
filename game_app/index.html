<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zero-Waste Kitchen - Pro Chef Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
   <link rel="stylesheet" href="styles/styles.css">
</head>

<body>
    <div id="navbar-container"></div>
    <div class="game-container">
        <div id="game-card" class="card p-6 md:p-8">
            <h1 id="game-title" class="text-3xl font-extrabold text-indigo-700 mb-4 text-center">Zero-Waste Kitchen</h1>
            <p id="game-description" class="text-gray-600 mb-6 text-center">Challenge: Plan 3 days of meals without
                wasting food!</p>

            <div id="status-bar" class="flex justify-between items-center bg-gray-100 p-3 rounded-lg mb-6 shadow-inner">
                <span id="score-display" class="font-bold text-lg text-red-600">Waste Score: 0%</span>
                <span id="day-display" class="font-bold text-lg text-gray-500">Day: 0 / 3</span>
            </div>

            <div id="game-content"></div>

            <div id="button-container" class="mt-8 flex justify-center">
                <button id="action-button"
                    class="action-button bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"></button>
            </div>
        </div>
    </div>

    <div id="notification-area"></div>

    <script>        
    
        class ZeroWasteGame {
            constructor() {
                this.elements = { /* ... DOM elements ... */ };
                this.elements = {
                    title: document.getElementById('game-title'),
                    description: document.getElementById('game-description'),
                    content: document.getElementById('game-content'),
                    actionButton: document.getElementById('action-button'),
                    scoreDisplay: document.getElementById('score-display'),
                    dayDisplay: document.getElementById('day-display'),
                    notificationArea: document.getElementById('notification-area'),
                };

                this.shoppingItems = [
                    { name: 'Fresh Carrots', cost: 15000, shelfLife: 3, id: 'carrot', emoji: 'ü•ï' },
                    { name: 'Rice (1kg)', cost: 25000, shelfLife: 50, id: 'rice', emoji: 'üçö' },
                    { name: 'Fresh Beef Steak', cost: 70000, shelfLife: 1, id: 'beef', emoji: 'ü•©' },
                    { name: 'Eggs (10 pcs)', cost: 30000, shelfLife: 7, id: 'egg', emoji: 'ü•ö' },
                    { name: 'Fresh Spinach', cost: 18000, shelfLife: 2, id: 'spinach', emoji: 'ü•¨' },
                    { name: 'Frozen Pork', cost: 45000, shelfLife: 30, id: 'pork', emoji: 'üêñ' },
                ];
                this.recipes = [
                    { id: 'pho', name: 'Beef Noodle Soup', required: ['beef', 'rice'], leftover: { name: 'Soup Base', id: 'soup_base', emoji: 'üç≤' } },
                    { id: 'fried_rice', name: 'Fried Rice', required: ['rice', 'egg'], leftover: { name: 'Leftover Rice', id: 'leftover_rice', emoji: 'üçö' } },
                    { id: 'spinach_soup', name: 'Spinach Soup', required: ['spinach'], leftover: { name: 'Veggie Broth', id: 'veggie_broth', emoji: 'ü•£' } },
                ];

                this.init();
            }

            init() {
                this.state = {
                    stage: 'welcome',
                    day: 0,
                    score: 0,
                    money: 200000, // Increased budget for quantity shopping
                    shoppingCart: new Map(), // Use a Map for quantities
                    inventory: [], // Will hold unique instances of items
                    leftovers: [],
                };
                this.render();
            }

            // --- UTILITY ---
            updateStatus() {
                this.elements.scoreDisplay.textContent = `Waste Score: ${this.state.score}%`;
                this.elements.dayDisplay.textContent = this.state.stage === 'planning' ? `Day: ${this.state.day} / 3` : `Budget: ${this.formatVND(this.state.money)}`;
            }
            formatVND(amount) { return amount.toLocaleString('vi-VN') + ' VND'; }
            showNotification(message, type = 'info') {
                const notif = document.createElement('div');
                notif.className = `notification ${type}`;
                notif.textContent = message;
                this.elements.notificationArea.appendChild(notif);
                setTimeout(() => notif.remove(), 4000);
            }

            // --- RENDER ENGINE ---
            render() {
                this.updateStatus();
                switch (this.state.stage) {
                    case 'welcome': this.renderWelcome(); break;
                    case 'shopping': this.renderShopping(); break;
                    case 'planning': this.renderPlanning(); break;
                    case 'final': this.renderFinal(); break;
                }
            }

            // --- STAGE 1: WELCOME ---
            renderWelcome() {
                // ... same as before ...
                this.elements.title.textContent = "Zero-Waste Kitchen";
                this.elements.description.textContent = "Your challenge: Plan 3 days of meals without wasting food or money!";
                this.elements.content.innerHTML = `<div class="text-center p-4"><p class="text-5xl mb-4">üõí ‚Üí üóìÔ∏è ‚Üí ‚ôªÔ∏è</p><p class="text-gray-600">Buy only what you need, cook creatively, and master your kitchen!</p></div>`;
                this.elements.actionButton.textContent = "Start Shopping";
                this.elements.actionButton.onclick = () => { this.state.stage = 'shopping'; this.render(); };
                this.elements.actionButton.disabled = false;
            }

            // --- STAGE 2: SHOPPING (REWORKED) ---
            renderShopping() {
                this.elements.title.textContent = "Stage 1: Smart Shopping";
                this.elements.description.textContent = `Add ingredients to your cart. Remember, your budget is ${this.formatVND(this.state.money)}. Don't buy more than you can cook!`;

                const listHtml = this.shoppingItems.map(item => {
                    const quantity = this.state.shoppingCart.get(item.id) || 0;
                    return `
                    <div id="shop-item-${item.id}" class="item-card p-4 border-2 rounded-xl text-center bg-gray-50 flex flex-col justify-between">
                        <div>
                            <p class="text-4xl">${item.emoji}</p>
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-indigo-500">${this.formatVND(item.cost)}</p>
                            <p class="text-xs ${item.shelfLife <= 2 ? 'text-red-500 font-bold' : 'text-gray-500'}">Shelf Life: ${item.shelfLife} days</p>
                        </div>
                        <div class="flex items-center justify-center mt-4 bg-gray-200 rounded-full">
                            <button class="quantity-btn font-bold text-xl w-8 h-8 rounded-full" onclick="game.updateCart('${item.id}', -1)">-</button>
                            <span class="font-bold text-lg w-10 text-center">${quantity}</span>
                            <button class="quantity-btn font-bold text-xl w-8 h-8 rounded-full" onclick="game.updateCart('${item.id}', 1)">+</button>
                        </div>
                    </div>
                `}).join('');

                this.elements.content.innerHTML = `<div class="grid grid-cols-2 md:grid-cols-3 gap-4">${listHtml}</div>`;
                this.elements.actionButton.textContent = "Proceed to Meal Planning";
                this.elements.actionButton.onclick = () => this.startPlanningPhase();
                // Can proceed if at least one item is in the cart
                this.elements.actionButton.disabled = this.state.shoppingCart.size === 0;
            }

            updateCart(itemId, amount) {
                const item = this.shoppingItems.find(i => i.id === itemId);
                const currentQuantity = this.state.shoppingCart.get(itemId) || 0;

                if (amount > 0) { // Adding to cart
                    if (this.state.money >= item.cost) {
                        this.state.money -= item.cost;
                        this.state.shoppingCart.set(itemId, currentQuantity + 1);
                    } else {
                        this.showNotification("Not enough money!", "error");
                    }
                } else { // Removing from cart
                    if (currentQuantity > 0) {
                        this.state.money += item.cost;
                        this.state.shoppingCart.set(itemId, currentQuantity - 1);
                        if (this.state.shoppingCart.get(itemId) === 0) {
                            this.state.shoppingCart.delete(itemId);
                        }
                    }
                }
                this.renderShopping(); // Re-render to update quantities and budget
            }

            startPlanningPhase() {
                if (this.state.shoppingCart.size === 0) {
                    this.showNotification("Your cart is empty! Buy something first.", "error");
                    return;
                }
                // Create unique instances for each item in inventory
                let instanceId = 0;
                this.state.inventory = [];
                this.state.shoppingCart.forEach((quantity, itemId) => {
                    for (let i = 0; i < quantity; i++) {
                        const itemData = this.shoppingItems.find(item => item.id === itemId);
                        this.state.inventory.push({ ...itemData, instanceId: instanceId++ });
                    }
                });

                this.state.stage = 'planning';
                this.state.day = 1;
                this.render();
            }

            // --- STAGE 3: PLANNING (REWORKED FOR DRAG & DROP) ---
            renderPlanning() {
                // Spoilage check
                this.state.inventory.forEach(item => {
                    if (item.shelfLife <= 0 && !item.used) {
                        item.used = true;
                        item.spoiled = true;
                        this.state.score += 15;
                        this.showNotification(`${item.name} spoiled! +15% waste.`, 'error');
                    }
                });

                if (this.state.day > 3) {
                    this.startFinalPhase();
                    return;
                }

                this.updateStatus();
                this.elements.title.textContent = `Stage 2: Meal Planning (Day ${this.state.day})`;
                this.elements.description.textContent = "Drag your ingredients from the fridge onto a recipe to cook it.";

                const inventoryHtml = this.state.inventory.filter(i => !i.used).map(item => `
                    <div id="inv-item-${item.instanceId}" class="inventory-item p-2 rounded-lg text-center bg-yellow-100" draggable="true" ondragstart="game.dragStart(event, ${item.instanceId})">
                        <p class="text-2xl pointer-events-none">${item.emoji}</p>
                        <p class="font-semibold text-sm pointer-events-none">${item.name}</p>
                        <p class="text-xs pointer-events-none ${item.shelfLife <= 1 ? 'text-red-500 font-bold' : ''}">Expires in: ${item.shelfLife} days</p>
                    </div>
                `).join('') || '<p class="text-gray-500 text-sm text-center">Your fridge is empty!</p>';

                const recipesHtml = this.recipes.map(recipe => {
                    const requiredEmojis = recipe.required.map(reqId => this.shoppingItems.find(i => i.id === reqId)?.emoji || '‚ùî').join(' + ');
                    return `
                        <div id="recipe-${recipe.id}" class="recipe-card p-3 border-2 border-gray-200 rounded-xl text-center bg-gray-50 flex flex-col justify-between" ondragover="game.dragOver(event, '${recipe.id}')" ondragleave="game.dragLeave(event, '${recipe.id}')" ondrop="game.dropOnRecipe(event, '${recipe.id}')">
                            <div>
                                <p class="font-bold text-indigo-600">${recipe.name}</p>
                                <p class="text-2xl my-2 pointer-events-none">${requiredEmojis}</p>
                            </div>
                            <p class="text-xs text-gray-500 mt-2 pointer-events-none">Drop ingredients here</p>
                        </div>
                    `;
                }).join('');

                this.elements.content.innerHTML = `
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 p-4 bg-gray-50 rounded-xl">
                            <h3 class="font-bold mb-3 text-lg text-gray-700 text-center">Your Fridge</h3>
                            <div class="grid grid-cols-2 gap-2">${inventoryHtml}</div>
                        </div>
                        <div class="md:col-span-2 p-4 bg-indigo-50 rounded-xl">
                            <h3 class="font-bold mb-3 text-lg text-indigo-700 text-center">Recipe Book</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">${recipesHtml}</div>
                        </div>
                    </div>
                `;
                this.elements.actionButton.textContent = "End Day & Tidy Up";
                this.elements.actionButton.onclick = () => this.advanceDay();
                this.elements.actionButton.disabled = false;
            }

            dragStart(event, instanceId) {
                event.dataTransfer.setData("text/plain", instanceId);
            }

            dragOver(event, recipeId) {
                event.preventDefault();
                document.getElementById(`recipe-${recipeId}`).classList.add('droppable');
            }

            dragLeave(event, recipeId) {
                document.getElementById(`recipe-${recipeId}`).classList.remove('droppable');
            }

            dropOnRecipe(event, recipeId) {
                event.preventDefault();
                const instanceId = parseInt(event.dataTransfer.getData("text/plain"));
                const draggedItem = this.state.inventory.find(i => i.instanceId === instanceId);
                const recipe = this.recipes.find(r => r.id === recipeId);
                document.getElementById(`recipe-${recipeId}`).classList.remove('droppable');

                if (!this.tempCookingSlot) {
                    this.tempCookingSlot = { recipeId: null, items: [] };
                }

                // If starting a new recipe, clear the old one
                if (this.tempCookingSlot.recipeId !== recipeId) {
                    this.tempCookingSlot.recipeId = recipeId;
                    this.tempCookingSlot.items = [];
                }

                // Check if item is needed and not already added
                const isNeeded = recipe.required.includes(draggedItem.id);
                const alreadyAddedCount = this.tempCookingSlot.items.filter(i => i.id === draggedItem.id).length;
                const requiredCount = recipe.required.filter(id => id === draggedItem.id).length;

                if (isNeeded && alreadyAddedCount < requiredCount && !draggedItem.used) {
                    this.tempCookingSlot.items.push(draggedItem);
                    draggedItem.used = true; // Temporarily mark as used
                    this.showNotification(`Added ${draggedItem.name} to ${recipe.name}!`, "info");

                    // Visually disable the dragged item
                    document.getElementById(`inv-item-${instanceId}`).style.opacity = '0.4';

                    // Check if recipe is complete
                    if (this.tempCookingSlot.items.length === recipe.required.length) {
                        this.cookMeal(recipe);
                    }
                } else {
                    this.showNotification("This ingredient isn't needed here or you've added enough.", "error");
                }
            }

            cookMeal(recipe) {
                this.showNotification(`Success! You cooked ${recipe.name}.`, "success");
                // Leftovers logic
                if (recipe.leftover) { this.state.leftovers.push({ ...recipe.leftover }); }
                // Clear the temporary cooking slot
                this.tempCookingSlot = { recipeId: null, items: [] };
                // Advance to the next day
                this.advanceDay();
            }

            advanceDay() {
                this.state.day++;
                this.state.inventory.forEach(item => {
                    if (!item.used) item.shelfLife -= 1;
                });
                this.render();
            }

            // --- FINAL STAGE ---
            startFinalPhase() {
                // Final penalty for unused items
                this.state.inventory.forEach(item => {
                    if (!item.used && !item.spoiled) {
                        this.state.score += 10;
                        this.showNotification(`${item.name} was not used! +10% waste.`, "error");
                    }
                });
                this.state.stage = 'final';
                this.render();
            }

            renderFinal() {
                this.updateStatus();
                this.elements.dayDisplay.textContent = "Challenge Complete";

                let finalMessage = '';
                let finalEmoji = '';

                if (this.state.score === 0) {
                    finalMessage = "Perfect! You are a Zero-Waste Master Chef! A true inspiration.";
                    finalEmoji = 'üèÜ';
                } else if (this.state.score <= 25) {
                    finalMessage = "Excellent work! You planned your meals wisely and saved leftovers creatively.";
                    finalEmoji = 'üëç';
                } else {
                    finalMessage = "Good effort, but there's room to improve. Careful shopping and planning are key!";
                    finalEmoji = 'üóëÔ∏è';
                }

                this.elements.title.textContent = "Final Results";
                this.elements.description.textContent = "Thanks for playing! Every small choice makes a big difference.";
                this.elements.content.innerHTML = `
                    <div class="text-center p-6 bg-indigo-50 rounded-xl">
                        <p class="text-6xl mb-4">${finalEmoji}</p>
                        <p class="text-2xl font-extrabold text-indigo-700 mb-3">Final Waste Score: ${this.state.score}%</p>
                        <p class="text-lg text-gray-700">${finalMessage}</p>
                    </div>
                `;
                this.elements.actionButton.textContent = "Play Again";
                this.elements.actionButton.onclick = () => this.init();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
        fetch('assets/nav.html')
        .then(r => { if (!r.ok) throw new Error(r.statusText); return r.text(); })
        .then(html => { document.getElementById('navbar-container').innerHTML = html; })
        .catch(err => console.warn('Failed to load nav:', err));
        });
        const game = new ZeroWasteGame();
    </script>
</body>

</html>